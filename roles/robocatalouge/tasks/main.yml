- name: Disable default nodejs module and enable version
  ansible.builtin.shell: |
        dnf module disable nodejs -y
        dnf module enable nodejs:20 -y

- name: install nodejs
  ansible.builtin.dnf: 
    name: nodejs
    state: latest

- name: add nodejs userid
  ansible.builtin.user:
      name: roboshop
      state: present

- name: create directory for application
  ansible.builtin.file:
      path : /app
      state: directory        

- name: Install unzip
  ansible.builtin.package:
    name: unzip
    state: present        

- name: Download and extract files from remote
  ansible.builtin.unarchive: 
    src: https://roboshop-artifacts.s3.amazonaws.com/catalogue-v3.zip
    dest: /app
    remote_src: yes

- name: Run npm install in /app
  ansible.builtin.command:
    cmd: npm install
    chdir: /app      

- name: copy catalouge service
  ansible.builtin.copy:
    src: catalogue.service
    dest: /etc/systemd/system/catalogue.service


- name: copy mongorepo file
  ansible.builtin.copy:
    src: mongo.repo
    dest: /etc/yum.repos.d/mongo.repo

- name: install mongodb
  ansible.builtin.dnf:
    name: mongodb-mongosh
    state: latest 

- name: load master data
  ansible.builtin.shell: mongosh --host 10.0.0.7  </app/db/master-data.js

- name: Reload systemd daemon                                                                                                                                 
  ansible.builtin.systemd:                                                                                                                                    
        daemon_reload: yes                                                                                                                                    
                                                                                                                                                              
- name: Enable catalogue service                                                                                                                              
  ansible.builtin.systemd:                                                                                                                                    
        name: catalogue                                                                                                                                       
        enabled: yes                                                                                                                                          
                                                                                                                                                              
- name: Start catalogue service                                                                                                                               
  ansible.builtin.systemd:                                                                                                                                    
        name: catalogue                                                                                                                                       
        state: started  


